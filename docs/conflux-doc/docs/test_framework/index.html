<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus">


<title data-react-helmet="true">test_framework | Conflux</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="Conflux"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" name="description" content="#Test Framework"><meta data-react-helmet="true" property="og:description" content="#Test Framework"><meta data-react-helmet="true" property="og:url" content="https://devdoctest.conflux-chain.org/docs/conflux-doc/docs/test_framework">

<link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico">


<link rel="stylesheet" href="/styles.dfe3753f.css">


<link rel="preload" href="/styles.420a66b5.js" as="script">

<link rel="preload" href="/runtime~main.4df7ac6a.js" as="script">

<link rel="preload" href="/main.8c24596b.js" as="script">

<link rel="preload" href="/1.a4438468.js" as="script">

<link rel="preload" href="/2.7fc9b08f.js" as="script">

<link rel="preload" href="/3.860440fb.js" as="script">

<link rel="preload" href="/1be78505.bcb87f63.js" as="script">

<link rel="preload" href="/20ac7829.47057717.js" as="script">

<link rel="preload" href="/17896441.3878441d.js" as="script">

<link rel="preload" href="/15aaea8b.1cd1448e.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="Conflux Logo"><strong class="navbar__title">Conflux Developer</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://github.com/Conflux-Chain/conflux-developer-site">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="Conflux Logo"><strong class="navbar__title">Conflux Developer</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://github.com/Conflux-Chain/conflux-developer-site">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><main class="docMainContainer_FFX1"><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">test_framework</h1></header><div class="markdown"><p>#Test Framework</p><p>The framework is written in python3. It can setup multiple Conflux nodes and test the distributed system behavior locally. It controls the nodes behavior by setting the node configurations, calling their RPCs, or sending them P2P messages directly.</p><p>All related files are included in the directory  tests. </p><p>After compiling the source code with cargo build --release under the project directory, you can run tests/test_all.py to run all included python tests.</p><p>##An Example Test</p><p>Here is an example test. It setups 2 nodes, makes each node generate some blocks separately, and finally connects them to check if they can receive the blocks generated by the other.</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">from test_framework.test_framework import ConfluxTestFramework</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">from test_framework.util import *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class ExampleTest(ConfluxTestFramework):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def set_test_params(self):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self.setup_clean_chain = True</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self.num_nodes = 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def setup_network(self):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self.setup_nodes()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        # connect_sample_nodes(self.nodes, self.log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def run_test(self):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self.nodes[0].generate(1, 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        assert (self.nodes[0].getblockcount() == 2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self.nodes[1].generate(2, 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        assert (self.nodes[1].getblockcount() == 3)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        connect_nodes(self.nodes, 0, 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sync_blocks(self.nodes)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        assert (self.nodes[0].getblockcount() == 4)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self.log.info(&quot;PASS&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if __name__ == &#x27;__main__&#x27;:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ExampleTest().main()</span></div></code></pre></div><p>The framework will</p><ol><li>Call set_test_params to set basic test initialization parameters.</li><li>Setup the test directories and node configurations according to the parameters set in set_test_params. By default, a temp directory will be created and all files will be kept within it. For example, setting self.num_nodes = 2 will initialize directories for two nodes.</li><li>Call setup_network to add nodes and connect them. Here self.setup_nodes() will add 2 Conflux nodes by running pre-compiled Conflux executable binary within the directory setupped in step 2. We do not connect them here because we want nodes seperated at the beginning.</li><li>Call run_test to run the actual test codes.</li></ol><p>After running self.setup_nodes(), self.nodes is a list of TestNode, and each can be used to interact with the corresponding Conflux node. For example, to get the number of blocks in node 0 by calling the RPC named getblockcount, you simply call self.nodes[0].getblockcount and an integer will be returned.</p><p>connect_nodes(self.nodes, 0, 1) connects nodes 0 and 1. sync_blocks(self.nodes) waits until all nodes have the same pivot chain tip. Them are both implemented by calling RPCs, and more useful functions will be introduced in [Utility Function List][#utility-function-list].</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="user-content-sending-p2p-messages"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#user-content-sending-p2p-messages" title="Direct link to heading">#</a>Sending P2P Messages</h2><p>After calling start_p2p_connection(self.nodes), the field p2p of each TestNode will be initialized with a simulated Conflux node written in Python, and this simulated node will be connected to the Conflux process controled by the corresponding TestNode. After that, you can send and receive P2P messages within python code. Here is an example about how to use p2p to interact with the Conflux node.</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    def run_test(self):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        def assert_length(_node, msg):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            assert_equal(len(msg.headers), 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        h = WaitHandler(self.nodes[0].p2p, GET_BLOCK_HEADERS_RESPONSE, assert_length)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        self.nodes[0].p2p.send_protocol_msg(GetBlockHeaders(hashes=[self.nodes[0].p2p.genesis.hash]))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        h.wait()</span></div></code></pre></div><p>This example tries to get the genesis block header from node 0 with P2P requests (instead of using RPC), and asserts that only one header is returned.</p><p>WaitHandler will wait for the first message of the designated message type and run a function on this received message. p2p.send_protocol_msg is used to send a rlp-encodable message. h.wait() waits and handles the first received GET_BLOCK_HEADERS_RESPONSE message. Note that WaitHandler starts listening right after it&#x27;s initialized.</p><p>##Configurations</p><p>By default, tests will use the release version executable binary built by cargo. If you want to use a file at another path (e.g., a debug version binary), you can set the environment variable CONFLUX to the full path of the used binary file before running the tests.</p><p>TODO</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="user-content-utility-function-list"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#user-content-utility-function-list" title="Direct link to heading">#</a>Utility Function List</h2><p>TODO</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="user-content-introduction-to-existing-python-tests"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#user-content-introduction-to-existing-python-tests" title="Direct link to heading">#</a>Introduction to Existing Python Tests</h2><p>TODO</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/Conflux-Chain/conflux-developer-site/edit/master/docs/conflux-doc/docs/test_framework.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2020-04-20T03:06:19.000Z" class="docLastUpdatedAt_1sqk">4/20/2020</time> by <strong>ConfluxBot</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/en/conflux_overview">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/conflux-portal/docs/en/portal/introduction">Portal</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://bounty.conflux-chain.org">Bounty</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/Conflux-Chain">GitHub</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://twitter.com/Conflux_Network">Twitter</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 Conflux Chain, Inc. Built with Docusaurus.</div></div></div></footer>
</div>

<script src="/styles.420a66b5.js"></script>

<script src="/runtime~main.4df7ac6a.js"></script>

<script src="/main.8c24596b.js"></script>

<script src="/1.a4438468.js"></script>

<script src="/2.7fc9b08f.js"></script>

<script src="/3.860440fb.js"></script>

<script src="/1be78505.bcb87f63.js"></script>

<script src="/20ac7829.47057717.js"></script>

<script src="/17896441.3878441d.js"></script>

<script src="/15aaea8b.1cd1448e.js"></script>


</body>
</html>